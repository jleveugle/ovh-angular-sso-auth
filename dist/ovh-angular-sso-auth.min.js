/*! ovh-angular-sso-auth - 3.1.2 - 2017-06-29 */
angular.module("ovh-angular-sso-auth",["ngCookies"]),angular.module("ovh-angular-sso-auth").provider("ssoAuthentication",function(){"use strict";var a="https://www.ovh.com/auth",b="https://www.ovh.com/auth?action=disconnect",c="/engine/api/me",d=[],e="";this.setLoginUrl=function(b){a=b},this.setLogoutUrl=function(a){b=a},this.setUserUrl=function(a){c=a},this.setConfig=function(a){d=a};var f=function(f,g,h,i,j){var k=!1,l={"Content-Type":"application/json;charset=utf-8",Accept:"application/json"},m={login:f.defer(),logout:void 0,loginPage:void 0};this.userId=void 0,this.user={},this.getLoginUrl=function(){return a},this.getLogoutUrl=function(){return b},this.getUserUrl=function(){return c},this.getUrlPrefix=function(a){if(!d||!Array.isArray(d)||!d.length)return e;if(a){for(var b=0,c=null;b<d.length&&d[b].serviceType!==a;)b++;return c=d[b],c&&c.hasOwnProperty("urlPrefix")?c.urlPrefix:e}return d[0].urlPrefix},this.isLogged=function(){return m.login.promise.then(function(){return k})},this.getRequestPromise=function(){return this.isLogged().then(function(a){return a?g(function(){return!0},18e5):f.when(!0)})},this.setIsLoggedIn=function(){k=!0,m.login.resolve()},this.sessionCheckOrGoLogin=function(){var a=this;return this.isLogged().then(function(b){return b?void 0:a.goToLoginPage()})},this.getHeaders=function(){return l},this.getUserIdCookie=function(){return"function"==typeof j.get?j.get("USERID"):j.USERID},this.login=function(){var a=this;return $.ajax({url:a.getUserUrl(),method:"GET",headers:l}).done(function(b){a.user=b,k=!0}).fail(function(){k=!1}).always(function(){a.userId=a.getUserIdCookie(),m.login.resolve()}),m.login.promise},this.handleSwitchSession=function(){return i.location.reload(),f.defer().promise},this.getSsoAuthPendingPromise=function(){var a=this;return m.login.promise.then(function(){var b=a.getUserIdCookie();return a.userId!==b?a.handleSwitchSession(b):void 0})},this.logout=function(a){return m.logout||(m.logout=f.defer(),k=!1,g(function(){i.location.assign(b+(b.indexOf("onsuccess")>-1?"":(b.indexOf("?")>-1?"&":"?")+"onsuccess="+encodeURIComponent(a||h.absUrl())))},0)),m.logout.promise},this.goToLoginPage=function(b){return m.loginPage||(m.loginPage=f.defer(),g(function(){i.location.assign(a+(a.indexOf("onsuccess")>-1?"":(a.indexOf("?")>-1?"&":"?")+"onsuccess="+encodeURIComponent(b||h.absUrl())))},0)),m.loginPage.promise}};this.$get=["$q","$timeout","$location","$window","$cookies",function(a,b,c,d,e){return new f(a,b,c,d,e)}]}),angular.module("ovh-angular-sso-auth").factory("ssoAuthInterceptor",["$q","ssoAuthentication",function(a,b){"use strict";return{request:function(c){var d=b.getUrlPrefix(c.serviceType),e=new RegExp(/(?:(?:\.html)|(?:Messages\w+\.json))$/i).test(c.url);return e?c:b.getSsoAuthPendingPromise().then(function(){if(c.headers=angular.extend(angular.copy(b.getHeaders()),c.headers),d&&!/^http(?:s)?:\/\//.test(c.url)&&(c.url=d+c.url),c.timeout){var e=a.defer();c.timeout.then(function(){e.resolve()}),c.noAuthenticate||b.getRequestPromise().then(function(){e.resolve()}),c.timeout=e.promise}else c.noAuthenticate||(c.timeout=b.getRequestPromise());return c})},responseError:function(c){return b.isLogged().then(function(d){return 403!==c.status||"This session is forbidden"!==c.data.message&&"This session is invalid"!==c.data.message||(c.status=401),401!==c.status||c.config.preventLogout?471===c.status?(b.goToLoginPage(),a.reject(c)):c.config&&c.config.noAuthenticate||d?a.reject(c):(b.logout(),a.reject(c)):(b.logout(),a.reject(c))})}}}]);